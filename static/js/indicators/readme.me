Мануал по индикаторам (обновлённая версия)
1. Общая структура
Каждый индикатор — это объект с двумя частями:

meta

id — уникальный идентификатор

name — название для UI

position — 'top' или 'bottom'

zIndex — порядок отрисовки

height — высота панели (для bottom)

defaultParams — дефолтные параметры (периоды, цвета, уровни, толщина линии и т.д.)

createIndicator Возвращает объект с методами:

render(localLayout) — отрисовка

updateHover(candle, idx) — обновление значений при наведении

2. Основные принципы
Очистка перед отрисовкой: graphics.clear() всегда в начале render.

LOD (Level of Detail):

Для линий используем step (прореживание точек) при большом числе баров.

Для bottom‑индикаторов — ограничиваем отрисовку видимым диапазоном (firstIdx, lastVisibleIdx) + буфер ±2 свечи.

Агрегация:

Верхние индикаторы (MA, SMA, EMA) и объём могут использовать агрегацию (суммирование/среднее по N свечам).

Bottom‑индикаторы (RSI, MACD, AO и т.д.) работают без агрегации, чтобы сохранить точность.

Overlay:

updateParam(id, text) — вывод параметров (например, период RSI).

updateValue(id, text) — вывод текущего значения или значения под курсором.

Hover‑логика:

Если курсор наведён (idx), показываем значение на этой свече.

Если нет — показываем последнее актуальное.

3. Вспомогательные функции
sma(values, p) — простое скользящее среднее

ema(values, p) — экспоненциальное скользящее среднее

stddev(values, p) — стандартное отклонение

trueRange(curr, prev) — для ATR

Все хелперы локальные внутри индикатора, чтобы не плодить глобальных зависимостей.

4. Философия
Минимум нагрузки: рисуем только то, что реально видно.

Простота: каждый индикатор — изолированный модуль, без скрытых зависимостей.

Единый стиль: все индикаторы пишутся по одному шаблону.

Гибкость: параметры берутся из meta.defaultParams, но могут быть переопределены пользователем.

5. Шаблон работы render
Получаем свечи: const candles = localLayout.candles;

Считаем значения: values = calculate(candles, params)

Определяем видимый диапазон + буфер

Очищаем графику

Рисуем: линия / бары / фон / нулевая линия

Обновляем overlay

6. Мини‑чеклист для нового индикатора
[ ] Заполнить meta

[ ] Реализовать calculate

[ ] В render: очистка → расчёт → видимый диапазон → отрисовка

[ ] В updateHover: логика курсора

[ ] Проверить overlay

⚡ Новое:

В defaultParams можно задавать lineWidth для толщины линии.

В render можно использовать лёгкое сглаживание (усреднение по окну) для визуальной стабильности без отключения LOD.

7. Расположение индикаторов

position: 'bottom' — классические панели под графиком (RSI, MACD, AO, ATR и т.д.).

position: 'top' — индикаторы над графиком (например, MA, EMA).

⚡ Новое: position: 'right' — боковые индикаторы (например, VPRV — профиль объёма), которые занимают фиксированную ширину и всю высоту плота.

8. Overlay расширения

updateParam(id, text) — параметры (например, «RSI 14»).

updateValue(id, text) — значения (например, «65.32»).

⚡ Новое: поддержка множественных значений (например, MACD: «0.123 / 0.456 / -0.789»).

⚡ Новое: для профилей (VPRV) можно выводить POC и Value Area: «POC 110000 / VA 70%».

9. Hover‑логика (расширенная)

Для линий: показываем значение под курсором.

Для баров (AO, MACD histogram): показываем значение конкретного бара.

⚡ Новое: для профилей (VPRV) hover может подсвечивать ценовой уровень и показывать объём на нём.

10. Производительность

Всегда использовать graphics.clear() перед отрисовкой.

Для длинных массивов — применять LOD (прореживание точек).

Для баров — рисовать только видимый диапазон + небольшой буфер.

⚡ Новое: при расчёте профилей (VPRV) — агрегировать только видимый диапазон свечей, чтобы не грузить память.

11. Дополнительные хелперы

normalize(values) — нормализация массива в диапазон [0..1].

scale(values, factor) — масштабирование.

⚡ Новое: binByPrice(candles, step) — агрегирование объёмов по ценовым уровням (для VPRV).

⚡ Новое: smoothArray(values, window) — лёгкое сглаживание для визуальной стабильности.

12. Чеклист для нестандартных индикаторов (VPRV, профили)

[ ] meta: указать position: 'right' и width.

[ ] calculate: агрегировать объёмы по ценовым уровням.

[ ] render: рисовать горизонтальные бары справа от графика.

[ ] overlay: выводить POC и Value Area.

[ ] updateHover: подсветка уровня и объёма под курсором.