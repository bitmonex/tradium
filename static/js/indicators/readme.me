Мануал по индикаторам


1. Общая структура

Каждый индикатор — это объект с двумя частями:

meta

id — уникальный идентификатор

name — название для UI

position — 'top' или 'bottom'

zIndex — порядок отрисовки

height — высота панели (для bottom)

defaultParams — дефолтные параметры (периоды, цвета, уровни и т.д.)

createIndicator Возвращает объект с методами:

render(localLayout) — отрисовка

updateHover(candle, idx) — обновление значений при наведении


2. Основные принципы

Очистка перед отрисовкой: graphics.clear() всегда в начале render.

LOD (Level of Detail):

Для линий используем step (прореживание точек) при большом числе баров.

Для bottom‑индикаторов — ограничиваем отрисовку видимым диапазоном (firstIdx, lastVisibleIdx) + буфер ±2 свечи.

Агрегация:

Верхние индикаторы (MA, SMA, EMA) и объём могут использовать агрегацию (суммирование/среднее по N свечам).

Bottom‑индикаторы (RSI, MACD, AO и т.д.) работают без агрегации, чтобы сохранить точность.

Overlay:

updateParam(id, text) — вывод параметров (например, 14, 70/30).

updateValue(id, text) — вывод текущего значения или значения под курсором.

Hover‑логика:

Если курсор наведён (idx), показываем значение на этой свече.

Если нет — показываем последнее актуальное.


3. Вспомогательные функции

sma(values, p) — простое скользящее среднее.

ema(values, p) — экспоненциальное скользящее среднее.

stddev(values, p) — стандартное отклонение.

trueRange(curr, prev) — для ATR.

Все хелперы локальные внутри индикатора, чтобы не плодить глобальных зависимостей.


4. Философия

Минимум нагрузки: рисуем только то, что реально видно.

Простота: каждый индикатор — изолированный модуль, без скрытых зависимостей.

Единый стиль: все индикаторы пишутся по одному шаблону, чтобы новый разработчик мог открыть любой файл и сразу понять механику.

Гибкость: параметры берутся из meta.defaultParams, но могут быть переопределены пользователем.


5. Шаблон работы render

Получаем свечи: const candles = localLayout.candles;

Считаем значения: values = calculate(candles, params)

Определяем видимый диапазон + буфер

Очищаем графику

Рисуем: линия / бары / фон / нулевая линия

Обновляем overlay


6. Мини‑чеклист для нового индикатора

[ ] Заполнить meta

[ ] Реализовать calculate

[ ] В render: очистка → расчёт → видимый диапазон → отрисовка

[ ] В updateHover: логика курсора

[ ] Проверить overlay


Теперь вы знаете...

где считать (calculate),

где рисовать (render),

где обновлять UI (overlay),

как работает LOD и агрегация.